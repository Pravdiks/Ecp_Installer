# ECP Installer (portable, Windows 10 x64)

## 1) Краткое ТЗ

Portable desktop-приложение под Windows 10 x64 для ускоренной установки ЭЦП с флешки без инсталлятора.

- Поддержка входных данных:
  - `*.pfx` / `*.p12` (сертификат + закрытый ключ).
  - `*.cer` / `*.crt` + папка контейнера (для сценария с CryptoPro CSP).
- Автодетект в выбранных папках/файлах: поддерживаемые элементы попадают в очередь задач, мусорные файлы (PDF/DOCX/JPG и т.д.) игнорируются.
- По умолчанию установка без админ-прав: `CurrentUser\My`.
- Если выбран `LocalMachine`, приложение честно уведомляет о требовании прав администратора и предлагает безопасный fallback в `CurrentUser`.
- Перед установкой нового сертификата удаляются только совпавшие «старые» сертификаты того же владельца (по `Issuer+Serial` и/или `CN/INN/OGRN`).
- Мульти-установка: ошибка одной задачи не останавливает остальные.
- Логирование: файл рядом с exe + live-лог в интерфейсе.

## 2) Архитектура и UI (2–3 состояния)

### Экран/состояние A: Подготовка
- Drag&drop файлов/папок.
- Кнопки: «Выбрать папку/файлы», «Сканировать», «Очистить список».
- Поля настроек: пароль (по умолчанию `123456`), Store (`CurrentUser/LocalMachine`), хранение контейнера (`Диск/Реестр`), Topmost.

### Экран/состояние B: Очередь задач
- Таблица задач установки (тип, путь сертификата, путь контейнера, статус, сообщение).
- Прогресс-бар.

### Экран/состояние C: Выполнение и аудит
- Кнопка «Установить всё» запускает последовательную обработку.
- Для каждой задачи: `Pending -> Running -> Success/Error/Skipped`.
- Внизу live-лог и кнопка «Открыть лог».

## 3) Структура проекта

```text
EcpInstaller.sln
EcpInstaller.App/
  App.xaml
  App.xaml.cs
  MainWindow.xaml
  MainWindow.xaml.cs
  EcpInstaller.App.csproj
  Models/
    Enums.cs
    SignatureTask.cs
  Helpers/
    RelayCommand.cs
    CertificateIdentityMatcher.cs
    WindowsPrincipalHelper.cs
  Services/
    AppLogger.cs
    ScanService.cs
    CryptoProCli.cs
    InstallService.cs
```

## 4) Сборка portable single-file .exe

> Выполнять на Windows-машине с установленным .NET SDK 8.

```bash
dotnet restore EcpInstaller.sln
dotnet publish EcpInstaller.App/EcpInstaller.App.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true
```

Итоговый exe будет в:

```text
EcpInstaller.App/bin/Release/net8.0-windows/win-x64/publish/EcpInstaller.exe
```

## 5) Краткая инструкция пользователя

1. Запустите `EcpInstaller.exe` с флешки.
2. Оставьте пароль `123456` или введите свой.
3. Выберите место установки сертификатов:
   - `CurrentUser` (рекомендуется без админа),
   - `LocalMachine` (требуются права администратора).
4. Выберите режим контейнера:
   - `Диск` (по умолчанию `D:\ECP_Containers`, fallback на `C:\ECP_Containers`),
   - `Реестр` (CurrentUser).
5. Добавьте файлы/папки (или перетащите мышью).
6. Нажмите «Сканировать», проверьте очередь.
7. Нажмите «Установить всё».
8. При необходимости откройте лог кнопкой «Открыть лог».
9. Кнопка «Сертификаты» открывает `certmgr.msc` (личные сертификаты текущего пользователя).

## 6) Ограничения по правам и безопасности

- Приложение **не** пытается обходить UAC и не выполняет скрытую эскалацию.
- Установка в `CurrentUser` работает без админа.
- Для `LocalMachine` проверяется роль администратора; при отсутствии прав пользователь получает понятный диалог с предложением переключиться в `CurrentUser`.
- Для CryptoPro-сценария требуется установленный CSP и `certmgr.exe`; при отсутствии выводится диагностическая ошибка.

## 7) Минимальный набор тест-кейсов (8 сценариев)

1. **PFX, правильный пароль, CurrentUser** → статус `Success`, сертификат появляется в `CurrentUser\My`.
2. **PFX, неверный пароль** → `Error`, остальные задачи продолжают выполняться.
3. **Папка с мусором (PDF/JPG/DOCX) + 1 PFX** → после сканирования в очереди только 1 задача.
4. **CER без контейнера** → `Error` с пояснением о недостающем контейнере.
5. **CER + контейнер + установленный CryptoPro** → успешная установка через `certmgr.exe`.
6. **Выбран LocalMachine без админ-прав** → предупреждение и предложение поставить в CurrentUser.
7. **Повторная установка нового сертификата того же владельца** → старый сертификат удаляется, новый устанавливается.
8. **Режим «Диск» без диска D:** → автопереход на `C:\ECP_Containers` с предупреждением.

## 8) Примечания по эксплуатационному окружению

- Текущая версия ориентирована на Windows 10/11 x64.
- Для сценариев с контейнерами CryptoPro нужна предустановленная инфраструктура CryptoPro CSP.
- Лог-файл создаётся рядом с исполняемым файлом: `EcpInstaller.log`.
